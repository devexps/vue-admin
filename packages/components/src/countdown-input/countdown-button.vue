<script setup lang="ts">
import { ref, watchEffect, computed, unref } from 'vue'
import { useCountdown } from './use-countdown'
import { isFunction } from '@devexps/utils'
import { useI18n } from '@devexps/locale'

const props = defineProps({
  value: { type: [Object, Number, String, Array] },
  count: { type: Number, default: 60 },
  beforeStartFunc: {
    type: Function as PropType<() => Promise<boolean>>,
    default: null,
  },
})

const loading = ref(false)

const { t } = useI18n()
const { currentCount, isStart, start, reset } = useCountdown(props.count)

const buttonText = computed(() => {
  return !unref(isStart)
    ? t('component.countdown.normalText')
    : t('component.countdown.sendText', [unref(currentCount)])
})

watchEffect(() => {
  props.value === undefined && reset()
})

/**
 * @description: Judge whether there is an external function before execution, and decide whether to start after execution
 */
async function handleStart() {
  const { beforeStartFunc } = props
  if (beforeStartFunc && isFunction(beforeStartFunc)) {
    loading.value = true
    try {
      const canStart = await beforeStartFunc()
      canStart && start()
    } finally {
      loading.value = false
    }
  } else {
    start()
  }
}
</script>
<template>
  <devexps-button
    v-bind="$attrs"
    :disabled="isStart"
    @click="handleStart"
    :loading="loading"
  >
    {{ buttonText }}
  </devexps-button>
</template>
